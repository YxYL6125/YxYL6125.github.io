<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="CASï¼ˆCompare And Swapï¼Œæ¯”è¾ƒå¹¶äº¤æ¢ï¼‰ï¼Œé€šå¸¸æŒ‡çš„æ˜¯è¿™æ ·ä¸€ç§åŸå­æ“ä½œï¼šé’ˆå¯¹ä¸€ä¸ªå˜é‡ï¼Œé¦–å…ˆæ¯”è¾ƒå®ƒçš„å†…å­˜å€¼ä¸æŸä¸ªæœŸæœ›å€¼æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒï¼Œå°±ç»™å®ƒèµ‹ä¸€ä¸ªæ–°å€¼ã€‚">
<meta property="og:type" content="website">
<meta property="og:title" content="CASå’ŒåŸå­ç±»æ“ä½œ">
<meta property="og:url" content="https://www.yxyl6125.eu.org/post_bak/CAS%E5%92%8C%E5%8E%9F%E5%AD%90%E7%B1%BB%E6%93%8D%E4%BD%9C.html">
<meta property="og:site_name" content="YxYLğŸ¥">
<meta property="og:description" content="CASï¼ˆCompare And Swapï¼Œæ¯”è¾ƒå¹¶äº¤æ¢ï¼‰ï¼Œé€šå¸¸æŒ‡çš„æ˜¯è¿™æ ·ä¸€ç§åŸå­æ“ä½œï¼šé’ˆå¯¹ä¸€ä¸ªå˜é‡ï¼Œé¦–å…ˆæ¯”è¾ƒå®ƒçš„å†…å­˜å€¼ä¸æŸä¸ªæœŸæœ›å€¼æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒï¼Œå°±ç»™å®ƒèµ‹ä¸€ä¸ªæ–°å€¼ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/YxYL6125/imgBad/main/img/image-20221219093920543.png">
<meta property="og:image" content="https://raw.githubusercontent.com/YxYL6125/imgBad/main/img/image-20221219190644368.png">
<meta property="og:image" content="https://raw.githubusercontent.com/YxYL6125/imgBad/main/img/image-20221219191150048.png">
<meta property="article:published_time" content="2022-12-19T01:02:12.000Z">
<meta property="article:modified_time" content="2022-12-20T10:53:36.000Z">
<meta property="article:author" content="YxYL">
<meta property="article:tag" content="TODO-LIST">
<meta property="article:tag" content="CAS">
<meta property="article:tag" content="åŸå­ç±»æ“ä½œ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/YxYL6125/imgBad/main/img/image-20221219093920543.png">
    
    
      
        
          
            <link rel="shortcut icon" href="https://www.gravatar.com/avatar/1c0ccb80f18de6871d3fd37b97cd3594?s=48">
          
        
      
      
        
          
            <link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/1c0ccb80f18de6871d3fd37b97cd3594?s=192" sizes="192x192">
          
        
      
      
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/1c0ccb80f18de6871d3fd37b97cd3594?s=180">
          
        
      
    
    <!-- title -->
    <title>CASå’ŒåŸå­ç±»æ“ä½œ</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->

    <script async defer
            data-website-id="e77e68be-f6e4-4br3-9365-2b76b57cd571"
            src="https://analytics.domain.com/umami.js">
    </script>


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
    <div class="content index py4 ">
        
          <header id="header">
  <a class="u-url u-uid" href="/">
  
    
      <img id="logo" alt class="u-logo" src="/images/logo.png" />
    
  
    <div id="title">
      <h1 class="p-name">YxYLğŸ¥</h1>
    </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#" aria-label="ç›®å½•"><i class="fa-solid fa-bars fa-2x"></i></a>
      </li>
      <!--
     --><li><a href="/">é¦–é¡µ</a></li><!--
   --><!--
     --><li><a href="/about/">å…³äº</a></li><!--
   --><!--
     --><li><a href="/archives/">å½’æ¡£</a></li><!--
   --><!--
     --><li><a href="/category/">åˆ†ç±»</a></li><!--
   --><!--
     --><li><a href="/tags/">tags</a></li><!--
   --><!--
     --><li><a target="_blank" rel="noopener" href="https://github.com/YxYL6125">é¡¹ç›®</a></li><!--
   -->
    </ul>
  </div>
</header>

        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  

  <div class="content" itemprop="articleBody">
      
          <h2 id="ä»€ä¹ˆæ˜¯CAS"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯CAS">Â¶</a>ä»€ä¹ˆæ˜¯CAS</h2>
<p>CAS(Compare And Swapï¼Œæ¯”è¾ƒå¹¶äº¤æ¢)ï¼Œé€šå¸¸æŒ‡çš„æ˜¯è¿™æ ·ä¸€ç§åŸå­æ“ä½œï¼š</p>
<blockquote>
<p>é’ˆå¯¹ä¸€ä¸ªå˜é‡ï¼Œé¦–å…ˆå…ˆæ¯”è¾ƒä»–çš„å†…å­˜å€¼ä¸æŸä¸ªæœŸæœ›å€¼æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒï¼Œå°±ç»™ä»–èµ‹ä¸€ä¸ªæ–°å€¼</p>
</blockquote>
<p>CASçš„é€»è¾‘ç”¨ä¼ªä»£ç æè¿°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(value == expectedValue)&#123;</span><br><span class="line">	value = newValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>CASå¯ä»¥çœ‹åšæ˜¯ä»–ä»¬åˆå¹¶åçš„æ•´ä½“â€”â€”ä¸€ä¸ªä¸å¯åˆ†å‰²çš„åŸå­æ“ä½œï¼Œå¹¶ä¸”èµ·åŸå­æ€§æ˜¯ç›´æ¥åœ¨ç¡¬ä»¶å±‚é¢å¾—åˆ°ä¿éšœçš„</li>
<li>CASè¯¾çœ‹åšæ˜¯ä¹è§‚é”(å¯¹æ¯”æ•°æ®åº“çš„æ‚²è§‚ã€ä¹è§‚é”)çš„ä¸€ç§å®ç°æ–¹å¼ï¼ŒJavaåŸå­ç±»ä¸­çš„é€’å¢æ“ä½œå°±é€šè¿‡CASè‡ªæ—‹å®ç°</li>
<li>CASæ˜¯ä¸€ç§æ— é”ç®—æ³•ï¼Œåœ¨ä¸ä½¿ç”¨é”(æ²¡æœ‰çº¿ç¨‹è¢«é˜»å¡)çš„æƒ…å†µä¸‹å®ç°å¤šçº¿ç¨‹ä¹‹é—´çš„å˜é‡åŒæ­¥</li>
</ul>
<h2 id="CASåº”ç”¨"><a class="header-anchor" href="#CASåº”ç”¨">Â¶</a>CASåº”ç”¨</h2>
<p>åœ¨Javaä¸­ï¼ŒCASæ“ä½œæ˜¯æœ‰<code>Unsafe</code>ç±»æä¾›æ”¯æŒçš„ï¼Œè¯¥ç±»å®šä¹‰äº†ä¸‰ç§é’ˆå¯¹ä¸åŒç±»å‹å˜é‡çš„CASæ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapObject</span><span class="params">(Object var1,<span class="type">long</span> var2,Object var4,Object var5)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapInt</span><span class="params">(Object var1,<span class="type">long</span> var2,<span class="type">int</span> var4,<span class="type">int</span> var5)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapLong</span><span class="params">(Object var1,<span class="type">long</span> var2,<span class="type">long</span> var4,<span class="type">long</span> var5)</span>;</span><br></pre></td></tr></table></figure>
<p>ä»–ä»¬éƒ½æ˜¯<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1744704">nativeæ–¹æ³•</a>ï¼Œç”±Javaè™šæ‹Ÿæœºæä¾›å…·ä½“å®ç°ï¼Œè¿™æ„å‘³ç€ä¸åŒçš„Javaè™šæ‹Ÿæœºå¯¹ä»–ä»¬çš„å®ç°å¯èƒ½ä¼šç•¥æœ‰ä¸åŒã€‚</p>
<p>ä»¥<code>compareAndSwapInt</code>ä¸ºä¾‹ï¼Œ<code>Unsafe</code>çš„<code>compareAndSwapInt</code>æ–¹æ³•æ¥æ”¶4ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li>å¯¹è±¡å®ä¾‹</li>
<li>å†…å­˜åç§»é‡(æœ‰headerçš„8ä¸ªå­—èŠ‚+x86æœºå™¨çš„å‹ç¼©æŒ‡é’ˆç²˜çš„4ä¸ªå­—èŠ‚+å¯¹è±¡å­˜å‚¨æ•°æ®æœ¬èº«çš„å­—èŠ‚æ•°ï¼Œå†æ·»ä¸Šå¯¹é½æ‰€éœ€è¦çš„å­—èŠ‚æ•°ä½¿ä¹‹æˆä¸º8çš„æ•´æ•°å€)</li>
<li>å­—æ®µæœŸæœ›å€¼</li>
<li>å­—æ®µæ–°å€¼</li>
</ol>
<p>è¿™ä¸ªæ–¹æ³•ä¼šé’ˆå¯¹æŒ‡å®šå¯¹è±¡å®ä¾‹ä¸­çš„å¯¹åº”åç§»é‡çš„å­—æ®µæ‰§è¡ŒCASæ“ä½œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CASTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Entity</span> <span class="variable">entity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entity</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> UnsafeFactory.getUnsafe();</span><br><span class="line"></span><br><span class="line">	<span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> UnsafeFactory.getFieldOffset(unsafe, Entity.class, <span class="string">&quot;x&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> successful;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 4ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ï¼šå¯¹è±¡å®ä¾‹ã€å­—æ®µçš„å†…å­˜åç§»é‡ã€å­—æ®µæœŸæœ›å€¼ã€å­—æ®µæ–°å€¼</span></span><br><span class="line">    successful = unsafe.compareAndSwapInt(entity, offset, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">    System.out.println(successful + <span class="string">&quot;\t&quot;</span> + entity.x);</span><br><span class="line"></span><br><span class="line">    successful = unsafe.compareAndSwapInt(entity, offset, <span class="number">3</span>, <span class="number">5</span>);</span><br><span class="line">    System.out.println(successful + <span class="string">&quot;\t&quot;</span> + entity.x);</span><br><span class="line"></span><br><span class="line">    successful = unsafe.compareAndSwapInt(entity, offset, <span class="number">3</span>, <span class="number">8</span>);</span><br><span class="line">    System.out.println(successful + <span class="string">&quot;\t&quot;</span> + entity.x);</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnsafeFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å– Unsafe å¯¹è±¡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">         field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">         <span class="keyword">return</span> (Unsafe) field.get(<span class="literal">null</span>);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">         &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å­—æ®µçš„å†…å­˜åç§»é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unsafe</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fieldName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">getFieldOffset</span><span class="params">(Unsafe unsafe, Class clazz, String fieldNam&#123;</span></span><br><span class="line"><span class="params">         <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="params">         return unsafe.objectFieldOffset(clazz.getDeclaredField(fieldName)</span>);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(e);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="CASç¼ºé™·"><a class="header-anchor" href="#CASç¼ºé™·">Â¶</a>CASç¼ºé™·</h2>
<p>CASè™½ç„¶é«˜æ ¡è§£å†³äº†åŸå­æ“ä½œä½†æ˜¯è¿˜æ˜¯å­˜åœ¨ä¸€äº›ç¼ºé™·ï¼Œä¸»è¦å˜ç°åœ¨ä¸‰ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>è‡ªæ—‹CASé•¿æ—¶é—´åœ°ä¸æˆåŠŸï¼Œè®©CPUåœ¨é‚£é‡Œç©ºè½¬ï¼Œå¯¼è‡´ç»™CPUå¸¦æ¥éå¸¸å¤§çš„å¼€é”€</li>
<li>åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ˜¯åˆ†å¸ƒå¼çš„è¯ï¼Œè¿˜æ˜¯è€è€å®å®ç”¨åˆ†å¸ƒå¼é”å§</li>
<li>ABAé—®é¢˜</li>
</ul>
<h3 id="ABAé—®é¢˜"><a class="header-anchor" href="#ABAé—®é¢˜">Â¶</a>ABAé—®é¢˜</h3>
<p>å½“æœ‰å¤šä¸ªçº¿ç¨‹å¯¹ä»–ä¸€ä¸ªåŸå­ç±»è¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼ŒæŸä¸ªçº¿ç¨‹åœ¨çŸ­æ—¶é—´å†…å°†åŸå­ç±»çš„å€¼Aä¿®æ”¹ä¸ºBï¼Œåˆé©¬ä¸Šå°†å…¶ä¿®æ”¹ä¸ºAï¼Œè¿™ä¸ªæ—¶å€™å…¶ä»–çº¿ç¨‹ä¸æ„ŸçŸ¥ï¼Œè¿˜æ˜¯ä¼šä¿®æ”¹æˆåŠŸ</p>
<p><img src="https://raw.githubusercontent.com/YxYL6125/imgBad/main/img/image-20221219093920543.png" alt="image-20221219093920543"></p>
<p>å…¶ä¸­ï¼Œå¯¹æŸä¸€ä¸ªå…±äº«å˜é‡çš„æ“ä½œåºåˆ—ä¸ºï¼šè¯»å–-ä¿®æ”¹-å†™å›(å³A-B-A)ï¼Œå¦‚æœåœ¨ä¿®æ”¹æ“ä½œBæœŸé—´ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¹Ÿå¯¹è¿™ä¸ªå˜é‡è¿›è¡Œäº†ä¿®æ”¹æ²¡é‚£ä¹ˆåŸæœ¬çš„ä¿®æ”¹æ“ä½œå°±ä¼šè¢«è¦†ç›–æ‰</p>
<p>ABAé—®é¢˜é€šå¸¸å‡ºç°åœ¨ä½¿ç”¨CASæ“ä½œçš„åœºæ™¯ä¸­ã€‚åœ¨è¿™äº›åœºæ™¯ä¸‹ï¼ŒABAé—®é¢˜å¯èƒ½ä¼šå¸¦æ¥éšæ‚£(åŒ…æ‹¬ä½†ä¸é™äºè¿™äº›åœºæ™¯)</p>
<ol>
<li>ä½¿ç”¨CASå®ç°çš„é”ï¼šå¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹è·å¾—é”ä¹‹åï¼Œå¦ä¸€ä¸ªçº¿ç¨‹åœ¨æ¬¡æœŸé—´å¯¹å…±äº«å˜é‡è¿›è¡Œäº†ä¿®æ”¹ï¼Œå¹¶ä¸”å°†å…¶ä¿®æ”¹å›å»ï¼Œé‚£ä¹ˆè¦åŸæœ¬çš„çº¿ç¨‹å¯èƒ½ä¼šåœ¨é‡Šæ”¾é”çš„æ—¶å€™å°†ä¿®æ”¹çš„å€¼å†™å›ï¼Œå¯¼è‡´çŠ¶æ€çš„æ··ä¹±</li>
<li>ä½¿ç”¨CASå®ç°çš„é˜Ÿåˆ—(å †æ ˆ)ï¼šå¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹å‘é˜Ÿåˆ—ä¸­æ’å…¥å…ƒç´ çš„åŒæ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å°†é˜Ÿåˆ—ä¸­çš„æŸä¸ªåŸåƒç´ åˆ é™¤ï¼Œå¹¶ä¸”å°†å…¶æ’å…¥å›æ¥ï¼Œé‚£ä¹ˆåŸæœ¬çš„çº¿ç¨‹å¯èƒ½ä¼šè®¤ä¸ºé˜Ÿåˆ—ä¸­ä»»ç„¶å­˜åœ¨è¿™ä¸ªå…ƒç´ ï¼Œå¯¼è‡´çŠ¶æ€çš„æ··ä¹±</li>
<li>â€¦â€¦</li>
</ol>
<h3 id="è§£å†³æ–¹æ¡ˆ"><a class="header-anchor" href="#è§£å†³æ–¹æ¡ˆ">Â¶</a>è§£å†³æ–¹æ¡ˆ</h3>
<p>æ•°æ®åº“æœ‰ä¸ªé”æˆä¸ºä¹è§‚é”ï¼Œæ˜¯ä¸€ç§åŸºäºæ•°æ®ç‰ˆæœ¬å®ç°çš„æ•°æ®åŒæ­¥æœºåˆ¶ï¼Œæ¯æ¬¡ä¿®æ”¹ä¸€æ¬¡æ•°æ®ï¼Œç‰ˆæœ¬å·å°±ä¼šè¿›è¡Œç´¯åŠ </p>
<p>åŒæ ·ï¼ŒJavaä¹Ÿæä¾›äº†ç›¸åº”çš„åŸå­å¼•ç”¨ç±»<code>AtomicStampedReference&lt;V&gt;</code></p>
<p><img src="https://raw.githubusercontent.com/YxYL6125/imgBad/main/img/image-20221219190644368.png" alt="image-20221219190644368"></p>
<ul>
<li><code>reference</code>å³æˆ‘ä»¬å®é™…å­˜å‚¨çš„å˜é‡ï¼Œ</li>
<li><code>stamp</code>æ˜¯ç‰ˆæœ¬ï¼Œæ¯æ¬¡ä¿®æ”¹å¯ä»¥é€šè¿‡+1æ¥ä¿è¯ç‰ˆæœ¬å”¯ä¸€æ€§</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®šä¹‰AtomicStampedReference </span></span><br><span class="line">        <span class="comment">// Pair.referenceå€¼ä¸º1, Pair.stampä¸º1</span></span><br><span class="line">        <span class="type">AtomicStampedReference</span> <span class="variable">atomicStampedReference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicStampedReference</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">int</span>[] stampHolder = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> (<span class="type">int</span>) atomicStampedReference.get(stampHolder);</span><br><span class="line">            <span class="type">int</span> <span class="variable">stamp</span> <span class="operator">=</span> stampHolder[<span class="number">0</span>];</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread1 read value: &quot;</span> + value + <span class="string">&quot;, stamp: &quot;</span> + stamp);</span><br><span class="line">            <span class="comment">// é˜»å¡1s</span></span><br><span class="line">            LockSupport.parkNanos(<span class="number">1000000000L</span>);</span><br><span class="line">            <span class="comment">// Thread1é€šè¿‡CASä¿®æ”¹valueå€¼ä¸º3</span></span><br><span class="line">            <span class="keyword">if</span> (atomicStampedReference.compareAndSet(value, <span class="number">3</span>, stamp, stamp + <span class="number">1</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread1 update from &quot;</span> + value + <span class="string">&quot; to 3&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread1 update fail!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;Thread1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">int</span>[] stampHolder = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> (<span class="type">int</span>) atomicStampedReference.get(stampHolder);</span><br><span class="line">            <span class="type">int</span> <span class="variable">stamp</span> <span class="operator">=</span> stampHolder[<span class="number">0</span>];</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread2 read value: &quot;</span> + value + <span class="string">&quot;, stamp: &quot;</span> + stamp);</span><br><span class="line">            <span class="comment">// Thread2é€šè¿‡CASä¿®æ”¹valueå€¼ä¸º2</span></span><br><span class="line">            <span class="keyword">if</span> (atomicStampedReference.compareAndSet(value, <span class="number">2</span>, stamp, stamp + <span class="number">1</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread2 update from &quot;</span> + value + <span class="string">&quot; to 2&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// do something</span></span><br><span class="line"></span><br><span class="line">                value = (<span class="type">int</span>) atomicStampedReference.get(stampHolder);</span><br><span class="line">                stamp = stampHolder[<span class="number">0</span>];</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread2 read value: &quot;</span> + value + <span class="string">&quot;, stamp: &quot;</span> + stamp);</span><br><span class="line">                <span class="comment">// Thread2é€šè¿‡CASä¿®æ”¹valueå€¼ä¸º1</span></span><br><span class="line">                <span class="keyword">if</span> (atomicStampedReference.compareAndSet(value, <span class="number">1</span>, stamp, stamp + <span class="number">1</span>)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Thread2 update from &quot;</span> + value + <span class="string">&quot; to 1&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;Thread2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Thread1 read value: 1, stamp: 1</span><br><span class="line">Thread2 read value: 1, stamp: 1</span><br><span class="line">Thread2 update from 1 to 2</span><br><span class="line">Thread2 read value: 2, stamp: 2</span><br><span class="line">Thread2 update from 2 to 1</span><br><span class="line">Thread1 update fail!</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±å¯ä»¥çœ‹åˆ°ï¼ŒABBé—®é¢˜å¾—åˆ°è§£å†³ã€‚Açº¿ç¨‹æ²¡æœ‰ä¿®æ”¹æˆåŠŸ</p>
<blockquote>
<p><code>AtomicMarkableReference</code>å¯ä»¥ç†è§£ä¸ºä¸Šé¢<code>AtomicStampedReference</code>çš„ç®€åŒ–ç‰ˆ</p>
<p><img src="https://raw.githubusercontent.com/YxYL6125/imgBad/main/img/image-20221219191150048.png" alt="image-20221219191150048"></p>
<p>å°±æ˜¯ä¸å…³å¿ƒä¿®æ”¹è¿‡å‡ æ¬¡ï¼Œä»…ä»…å…³å¿ƒæ˜¯å¦ä¿®æ”¹è¿‡</p>
<p>å› æ­¤å˜é‡<code>mark</code>æ˜¯<code>boolean</code>ç±»å‹ï¼Œä»…è®°å½•å€¼æ˜¯å¤Ÿæœ‰è¿‡ä¿®æ”¹</p>
</blockquote>
<h2 id="åŸå­ç±»æ“ä½œ"><a class="header-anchor" href="#åŸå­ç±»æ“ä½œ">Â¶</a>åŸå­ç±»æ“ä½œ</h2>
<p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­å¾ˆå®¹æ˜“å‡ºç°å¹¶å‘å®‰å…¨çš„é—®é¢˜</p>
<blockquote>
<p>æœ‰ä¸€ä¸ªå¾ˆç®€å•çš„ä¾‹å­å°±æ˜¯å¤šçº¿ç¨‹æ›´æ–°å˜é‡ <code>i=1</code>ï¼Œæ¯”å¦‚å¤šä¸ªçº¿ç¨‹æ‰§è¡Œ<code>i++</code>æ“ä½œï¼Œå°±æœ‰å¯èƒ½è·å–ä¸åˆ°æ­£ç¡®çš„å€¼ï¼Œè€Œè¿™ä¸ªé—®é¢˜ï¼Œæœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯é€šè¿‡<code>synchronized</code>è¿›è¡Œæ§åˆ¶æ¥è¾¾åˆ°çº¿ç¨‹å®‰å…¨çš„ç›®çš„ã€‚ä½†æ˜¯ç”±äº<code>synchronized</code>æ˜¯é‡‡ç”¨çš„æ‚²è§‚é”ç­–ç•¥ï¼Œå¹¶ä¸æ˜¯ç‰¹åˆ«é«˜æ•ˆçš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå®é™…ä¸Šï¼Œåœ¨JUCä¸‹çš„atomicåŒ…æä¾›äº†ä¸€ç³»åˆ—çš„æ“ä½œç®€å•ï¼Œæ€§èƒ½é«˜æ•ˆï¼Œå¹¶èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨çš„ç±»å»æ›´æ–°åŸºæœ¬ç±»å‹å˜é‡ï¼Œæ•°ç»„å…ƒç´ ï¼Œåº”ç”¨ç±»å‹ï¼Œä»¥åŠæ›´æ–°å¯¹è±¡ä¸­çš„å­—æ®µç±»å‹ï¼ŒatomicåŒ…ä¸‹çš„è¿™äº›ç±»éƒ½æ˜¯é‡‡ç”¨çš„æ˜¯ä¹è§‚é”ç­–ç•¥å»åŸå­æ›´æ–°æ•°æ®ï¼Œåœ¨javaä¸­åˆ™æ˜¯ä½¿ç”¨CASæ“ä½œå…·ä½“å®ç°ã€‚</p>
</blockquote>
<p>åœ¨<code>java.util.concurrent.atomic</code>åŒ…ä¸‹æä¾›äº†ä¸€ç»„åŸå­æ“ä½œç±»ï¼š</p>
<ul>
<li>åŸºæœ¬ç±»å‹ï¼š<code>AtomicIntegerã€AtomicLongã€AtomicBoolean</code></li>
<li>å¼•ç”¨ç±»å‹ï¼š<code>AtomicReferenceã€AtomicStampedRerenceã€AtomicMarkableReference</code></li>
<li>æ•°ç»„ç±»å‹ï¼š<code>AtomicIntegerArrayã€AtomicLongArrayã€AtomicReferenceArray</code></li>
<li>å¯¹è±¡å±æ€§åŸå­ä¿®æ”¹å™¨ï¼š<code>AtomicIntegerFieldUpdaterã€AtomicLongFieldUpdaterã€ AtomicReferenceFieldUpdater</code></li>
<li>åŸå­ç±»å‹ç´¯åŠ å™¨(jdk1.8è¿‡åå‡ºæ¥çš„)ï¼š<code>DoubleAccumulatorã€DoubleAdderã€ LongAccumulatorã€LongAdderã€Striped64</code></li>
</ul>
<h3 id="åŸå­æ›´æ–°åŸºæœ¬æ•°æ®"><a class="header-anchor" href="#åŸå­æ›´æ–°åŸºæœ¬æ•°æ®">Â¶</a>åŸå­æ›´æ–°åŸºæœ¬æ•°æ®</h3>
<p>ä»¥<code>AtomicInteger</code>æ€»ç»“ä¸‹å¸¸ç”¨æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä»¥åŸå­çš„æ–¹å¼å°†å®ä¾‹ä¸­çš„åŸå€¼åŠ 1ï¼Œè¿”å›çš„æ˜¯è‡ªå¢å‰çš„æ—§å€¼ï¼›</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndIncrement</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.getAndAddInt(<span class="built_in">this</span>, valueOffset, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//getAndSet(int newValue)ï¼šå°†å®ä¾‹ä¸­çš„å€¼æ›´æ–°ä¸ºæ–°å€¼ï¼Œå¹¶è¿”å›æ—§å€¼ï¼›</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">getAndSet</span><span class="params">(<span class="type">boolean</span> newValue)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> prev;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        prev = get();</span><br><span class="line">    &#125; <span class="keyword">while</span> (!compareAndSet(prev, newValue));</span><br><span class="line">    <span class="keyword">return</span> prev;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//incrementAndGet() ï¼šä»¥åŸå­çš„æ–¹å¼å°†å®ä¾‹ä¸­çš„åŸå€¼è¿›è¡ŒåŠ 1æ“ä½œï¼Œå¹¶è¿”å›æœ€ç»ˆç›¸åŠ åçš„ç»“æœï¼›</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">incrementAndGet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.getAndAddInt(<span class="built_in">this</span>, valueOffset, <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//addAndGet(int delta) ï¼šä»¥åŸå­æ–¹å¼å°†è¾“å…¥çš„æ•°å€¼ä¸å®ä¾‹ä¸­åŸæœ¬çš„å€¼ç›¸åŠ ï¼Œå¹¶è¿”å›æœ€åçš„ç»“æœï¼›</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">addAndGet</span><span class="params">(<span class="type">int</span> delta)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.getAndAddInt(<span class="built_in">this</span>, valueOffset, delta) + delta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æµ‹è¯•ä¸€ä¸‹</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">AtomicInteger</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;<span class="comment">// åŸå­è‡ªå¢ CAS</span></span><br><span class="line">                    sum.incrementAndGet();</span><br><span class="line">                    <span class="comment">//TODO</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(sum.get());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œå®Œè¿‡åï¼Œå€¼ä¸º10000çš„ç»“æœå‘ˆç°åœ¨é¢å‰â€¦â€¦</p>
<blockquote>
<p><code>incrementAndGet()</code>æ–¹æ³•é€šè¿‡CASè‡ªå¢å®ç°ï¼Œå¦‚æœCASå¤±è´¥ï¼Œè‡ªæ—‹ç›´åˆ°æˆåŠŸ+1ã€‚</p>
</blockquote>
<h3 id="åŸå­æ›´æ–°æ•°ç»„ç±»å‹"><a class="header-anchor" href="#åŸå­æ›´æ–°æ•°ç»„ç±»å‹">Â¶</a>åŸå­æ›´æ–°æ•°ç»„ç±»å‹</h3>
<p>ä»¥<code>AtomicIntegerArray</code>ä¸ºä¾‹æ€»ç»“å¸¸ç”¨çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//addAndGet(int i, int delta)ï¼šä»¥åŸå­æ›´æ–°çš„æ–¹å¼å°†æ•°ç»„ä¸­ç´¢å¼•ä¸ºiçš„å…ƒç´ ä¸è¾“å…¥å€¼ç›¸åŠ ï¼›</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">addAndGet</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> delta)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getAndAdd(i, delta) + delta;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//getAndIncrement(int i)ï¼šä»¥åŸå­æ›´æ–°çš„æ–¹å¼å°†æ•°ç»„ä¸­ç´¢å¼•ä¸ºiçš„å…ƒç´ è‡ªå¢åŠ 1ï¼›</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndIncrement</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getAndAdd(i, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//compareAndSet(int i, int expect, int update)ï¼šå°†æ•°ç»„ä¸­ç´¢å¼•ä¸ºiçš„ä½ç½®çš„å…ƒç´ è¿›è¡Œæ›´</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> expect, <span class="type">int</span> update)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> compareAndSetRaw(checkedByteOffset(i), expect, update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æµ‹è¯•ä¸€ä¸‹</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//é¦–å…ˆåˆ›å»ºæ•°ç»„</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span>[] value = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"><span class="comment">//å°†å…¶æ”¾åœ¨AtomicIntegerArrayæ„é€ å™¨ä¸­</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">AtomicIntegerArray</span> <span class="variable">atomicIntegerArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicIntegerArray</span>(value);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®ç´¢å¼•0çš„å…ƒç´ ä¸º100</span></span><br><span class="line">    atomicIntegerArray.set(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    System.out.println(atomicIntegerArray.get(<span class="number">0</span>));</span><br><span class="line">    <span class="comment">//ä»¥åŸå­æ›´æ–°çš„æ–¹å¼å°†æ•°ç»„ä¸­ç´¢å¼•ä¸º1çš„å…ƒç´ ä¸è¾“å…¥å€¼ç›¸åŠ </span></span><br><span class="line">    atomicIntegerArray.getAndAdd(<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">    System.out.println(atomicIntegerArray);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¾—åˆ°è¾“å‡ºç»“æœ</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">100</span><br><span class="line">[100, 7, 3, 4, 5]</span><br></pre></td></tr></table></figure>
<h3 id="åŸå­æ›´æ–°å¼•ç”¨ç±»å‹"><a class="header-anchor" href="#åŸå­æ›´æ–°å¼•ç”¨ç±»å‹">Â¶</a>åŸå­æ›´æ–°å¼•ç”¨ç±»å‹</h3>
<p><code>AtomicReference</code>ä½œç”¨æ˜¯å¯¹æ™®é€šå¯¹è±¡çš„å°è£…ï¼Œä»–å¯ä»¥ä¿è¯ä½ åœ¨ä¿®æ”¹å¯¹è±¡æ—¶çš„çº¿ç¨‹å®‰å…¨æ€§</p>
<p><strong>æµ‹è¯•ä¸€ä¸‹</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;å¼ ä¸‰&quot;</span>, <span class="number">23</span>);</span><br><span class="line">    <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;æå››&quot;</span>, <span class="number">25</span>);</span><br><span class="line">    <span class="type">User</span> <span class="variable">user3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;ç‹äº”&quot;</span>, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–ä¸º user1</span></span><br><span class="line">    AtomicReference&lt;User&gt; atomicReference = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;();</span><br><span class="line">    atomicReference.set(user1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æŠŠ user2 èµ‹ç»™ atomicReference</span></span><br><span class="line">    atomicReference.compareAndSet(user1, user2);</span><br><span class="line">    System.out.println(atomicReference.get());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æŠŠ user3 èµ‹ç»™ atomicReference</span></span><br><span class="line">    atomicReference.compareAndSet(user1, user3);</span><br><span class="line">    System.out.println(atomicReference.get());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User&#123;name=<span class="string">&#x27;æå››&#x27;</span>, age=<span class="number">25</span>&#125;</span><br><span class="line">User&#123;name=<span class="string">&#x27;æå››&#x27;</span>, age=<span class="number">25</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¯¹è±¡å±æ€§åŸå­ä¿®æ”¹å™¨"><a class="header-anchor" href="#å¯¹è±¡å±æ€§åŸå­ä¿®æ”¹å™¨">Â¶</a>å¯¹è±¡å±æ€§åŸå­ä¿®æ”¹å™¨</h3>
<p><code>AtomicIntegerFieldUpdater</code>å¯ä»¥çº¿ç¨‹å®‰å…¨åœ°æ›´æ–°å¯¹è±¡ä¸­çš„æ•´å½¢å˜é‡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicIntegerFieldUpdaterTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Candidate</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">score</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">score2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicIntegerFieldUpdater&lt;Candidate&gt; scoreUpdater =</span><br><span class="line">            AtomicIntegerFieldUpdater.newUpdater(Candidate.class, <span class="string">&quot;score&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">AtomicInteger</span> <span class="variable">realScore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Candidate</span> <span class="variable">candidate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Candidate</span>();</span><br><span class="line"></span><br><span class="line">        Thread[] t = <span class="keyword">new</span> <span class="title class_">Thread</span>[<span class="number">10000</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            t[i] = <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (Math.random() &gt; <span class="number">0.4</span>) &#123;</span><br><span class="line">                        candidate.score2.incrementAndGet();</span><br><span class="line">                        scoreUpdater.incrementAndGet(candidate);</span><br><span class="line">                        realScore.incrementAndGet();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            t[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            t[i].join();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;AtomicIntegerFieldUpdater Score=&quot;</span> + candidate.score);</span><br><span class="line">        System.out.println(<span class="string">&quot;AtomicInteger Score=&quot;</span> + candidate.score2.get());</span><br><span class="line">        System.out.println(<span class="string">&quot;realScore=&quot;</span> + realScore.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äº <code>AtomicIntegerFieldUPdater</code>çš„ä½¿ç”¨ç¨å¾®æœ‰ä¸€äº›é™åˆ¶å’Œçº¦æŸï¼š</p>
<ol>
<li>å­—æ®µå¿…é¡»æ˜¯volatileç±»å‹çš„ï¼Œåœ¨çº¿ç¨‹ä¹‹é—´å…±äº«å˜é‡æ—¶ä¿è¯ç«‹å³å¯è§</li>
<li>å­—æ®µçš„æè¿°ç±»å‹(ä¿®é¥°ç¬¦public/protect/default/private)ä¸è°ƒç”¨è€…ä¸æ“ä½œå¯¹è±¡å­—æ®µçš„å…³ç³»ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯è¯´è°ƒç”¨è€…èƒ½å¤Ÿç›´æ¥æ“ä½œå¯¹è±¡å­—æ®µï¼Œé‚£ä¹ˆå°±å¯ä»¥åå°„è¿›è¡ŒåŸå­æ“ä½œã€‚ä½†æ˜¯å¯¹äºçˆ¶ç±»çš„å­—æ®µï¼Œå­ç±»æ˜¯ä¸èƒ½ç›´æ¥æ“ä½œçš„ï¼Œå°½ç®¡å­ç±»å¯ä»¥è®¿é—®çˆ¶ç±»çš„å­—æ®µ</li>
<li>åªèƒ½æ˜¯å®ä¾‹å˜é‡ï¼Œä¸èƒ½æ˜¯ç±»å˜é‡ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸èƒ½åŠ <code>static</code>å…³é”®å­—</li>
<li>åªèƒ½æ˜¯å¯ä¿®æ”¹å˜é‡ï¼Œä¸èƒ½æ˜¯<code>final</code>å˜é‡ï¼Œå› ä¸º<code>final</code>çš„è¯­ä¹‰å°±æ˜¯ä¸å¯ä¿®æ”¹ã€‚å®é™…ä¸Š<code>final</code>çš„è¯­ä¹‰å’Œ<code>volatile</code>æ˜¯æœ‰å†²çªçš„ï¼Œè¿™ä¸¤ä¸ªå…³é”®å­—ä¸èƒ½åŒæ—¶å­˜åœ¨ã€‚</li>
<li>å¯¹äº<code>AtomicIntegerFieldUpdatert</code>å’Œ<code>AtomicLongFIeldUpdater</code>åªèƒ½ä¿®æ”¹int/longç±»å‹å­—æ®µï¼Œä¸èƒ½ä¿®æ”¹å™¨åŒ…è£…ç±»å‹(Integer/Long)ã€‚å¦‚æœè¦ä¿®æ”¹åŒ…è£…ç±»å‹å°±éœ€è¦ä½¿ç”¨<code>AtomicReferenceFieldUpdater</code></li>
</ol>
<blockquote>
<p><code>LongAdder</code>è¿˜æ²¡ç ”ç©¶ï¼Œç­‰ä»¥åæœ‰æ—¶é—´äº†æ¥å†ç ”ç©¶(ğŸ’©)</p>
</blockquote>

        
  </div>
</article>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2023
    YxYL
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">é¦–é¡µ</a></li><!--
     --><!--
       --><li><a href="/about/">å…³äº</a></li><!--
     --><!--
       --><li><a href="/archives/">å½’æ¡£</a></li><!--
     --><!--
       --><li><a href="/category/">åˆ†ç±»</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/YxYL6125">é¡¹ç›®</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
